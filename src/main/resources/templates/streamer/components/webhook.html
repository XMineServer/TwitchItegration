<div class="webhook-list" th:fragment="webhook" id="webhook-list">
    <div th:with="webhook=${webhooks.?[type.name() == 'CHANNEL_POINTS_REDEMPTION_ADD']?.get(0)}">
        <div th:if="${webhook == null}">
            <div class="webhook-row">
                <span class="webhook-label">Channel Points Redemption</span>
                <span class="webhook-status webhook-status-missing">Not created</span>
                <button type="button" class="webhook-btn"
                        onclick="webhookAction('POST')">Create</button>
            </div>
        </div>
        <div th:if="${webhook != null}">
            <!-- DEACTIVATED or REVOKED: Enable/Delete -->
            <div th:if="${webhook.status.name() == 'DEACTIVATED' or webhook.status.name() == 'REVOKED'}" class="webhook-row">
                <span class="webhook-label">Channel Points Redemption</span>
                <span class="webhook-status webhook-status-disabled"
                      th:text="${webhook.status.name()}">Disabled</span>
                <button type="button" class="webhook-btn"
                        onclick="webhookAction('POST')">Enable</button>
                <button type="button" class="webhook-btn webhook-btn-delete"
                        onclick="webhookAction('DELETE')">Delete</button>
            </div>
            <!-- ACTIVE: Disable/Delete -->
            <div th:if="${webhook.status.name() == 'ACTIVE'}" class="webhook-row">
                <span class="webhook-label">Channel Points Redemption</span>
                <span class="webhook-status webhook-status-enabled"
                      th:text="${webhook.status.name()}">Enabled</span>
                <button type="button" class="webhook-btn"
                        onclick="webhookAction('PATCH', {enable: false})">Disable</button>
                <button type="button" class="webhook-btn webhook-btn-delete"
                        onclick="webhookAction('DELETE')">Delete</button>
            </div>
            <!-- PENDING_ACTIVATION: Wait/Delete -->
            <div th:if="${webhook.status.name() == 'PENDING_ACTIVATION'}" class="webhook-row">
                <span class="webhook-label">Channel Points Redemption</span>
                <span class="webhook-status webhook-status-pending">Pending activation</span>
                <button type="button" class="webhook-btn" disabled>Wait...</button>
                <button type="button" class="webhook-btn webhook-btn-delete"
                        onclick="webhookAction('DELETE')">Delete</button>
            </div>
            <!-- PENDING_DEACTIVATION: Wait/Delete -->
            <div th:if="${webhook.status.name() == 'PENDING_DEACTIVATION'}" class="webhook-row">
                <span class="webhook-label">Channel Points Redemption</span>
                <span class="webhook-status webhook-status-pending">Pending deactivation</span>
                <button type="button" class="webhook-btn" disabled>Wait...</button>
                <button type="button" class="webhook-btn webhook-btn-delete"
                        onclick="webhookAction('DELETE')">Delete</button>
            </div>
            <!-- PROBLEM: Retry/Delete -->
            <div th:if="${webhook.status.name() == 'PROBLEM'}" class="webhook-row">
                <span class="webhook-label">Channel Points Redemption</span>
                <span class="webhook-status webhook-status-problem">Problem</span>
                <button type="button" class="webhook-btn"
                        onclick="webhookAction('POST')">Retry</button>
                <button type="button" class="webhook-btn webhook-btn-delete"
                        onclick="webhookAction('DELETE')">Delete</button>
            </div>
        </div>
    </div>
</div>
<script>
function webhookAction(method, params = {}) {
    let url = '/streamer/webhook/channelPointsRedemption';
    const query = Object.keys(params)
        .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))
        .join('&');
    if (query) {
        url += '?' + query;
    }
    let options = { method: method };
    fetch(url, options)
        .then(resp => {
            if (resp.ok) {
                location.reload();
            } else {
                alert('Webhook action failed');
            }
        })
        .catch(() => alert('Webhook action failed'));
}
</script>
